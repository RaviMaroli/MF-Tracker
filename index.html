<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mutual Fund Tracker</title>
<style>
body { font-family: Arial, sans-serif; padding: 10px; }
input, select, button { padding: 6px; margin: 3px 0; font-size: 16px; }
.button-fund { 
  padding: 4px 8px; 
  border-radius: 5px; 
  border: 1px solid #007bff; 
  background-color: #007bff; 
  color: white; 
  cursor: pointer; 
  font-size: 14px;
  transition: background-color 0.2s;
}
.button-fund:hover { background-color: #0056b3; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
input[type="number"] { width: 90px; }
.profit { color: green; font-weight: bold; }
.loss { color: red; font-weight: bold; }
#fundInput { width: 50%; }
#fundDropdown { width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; display: none; position: absolute; background: #fff; z-index: 1000; }
#fundDropdown div { padding: 5px; cursor: pointer; }
#fundDropdown div:hover { background: #eee; }
.container { position: relative; }
.total-row { font-weight: bold; background: #f0f0f0; }
button { margin-right: 5px; margin-top: 5px; }
</style>
</head>
<body>

<h2>Mutual Fund Tracker</h2>

<div class="container">
  <input type="text" id="fundInput" placeholder="Type fund name (partial)">
  <div id="fundDropdown"></div>
</div>

<div>
  <button onclick="refreshNAVs()">ðŸ”„ Refresh NAVs</button>
  <button onclick="clearAllFunds()">ðŸ—‘ Clear All</button>
</div>

<table>
  <thead>
    <tr>
      <th>Fund</th>
      <th>Current NAV (â‚¹)</th>
      <th>Buy Avg (â‚¹)</th>
      <th>Investment (â‚¹)</th>
      <th>P / L (â‚¹)</th>
    </tr>
  </thead>
  <tbody id="fundTable"></tbody>
</table>

<script>
let funds = JSON.parse(localStorage.getItem("funds") || "[]");
let mfList = [];

fetch("https://api.mfapi.in/mf")
  .then(r => r.json())
  .then(data => mfList = data);

function save() { localStorage.setItem("funds", JSON.stringify(funds)); }

function render() {
  const tbody = document.getElementById("fundTable");
  tbody.innerHTML = "";
  let totalInvestment = 0, totalPL = 0;

  funds.forEach((f,i) => {
    let pl = 0, units = 0;
    if(f.buyAvg > 0 && f.invest > 0 && f.nav > 0){
      units = f.invest / f.buyAvg;
      pl = units * f.nav - f.invest;
      totalPL += pl;
      totalInvestment += parseFloat(f.invest) || 0;
    }

    tbody.innerHTML += `
      <tr>
        <td><button class="button-fund" onclick="removeFund(${i})">${f.name}</button></td>
        <td>${f.nav || "-"}</td>
        <td><input type="number" step="0.01" value="${f.buyAvg}" onchange="funds[${i}].buyAvg=this.value; save(); render();"></td>
        <td><input type="number" value="${f.invest}" onchange="funds[${i}].invest=this.value; save(); render();"></td>
        <td class="${pl>=0?'profit':'loss'}">${pl.toFixed(2)}</td>
      </tr>
    `;
  });

  if(funds.length>0){
    tbody.innerHTML += `
      <tr class="total-row">
        <td>Total</td>
        <td>-</td>
        <td>-</td>
        <td>${totalInvestment.toFixed(2)}</td>
        <td class="${totalPL>=0?'profit':'loss'}">${totalPL.toFixed(2)}</td>
      </tr>
    `;
  }
}

function addFund(selectedFund){
  if(funds.length >=20){ alert("Max 20 funds allowed"); return; }
  fetch(`https://api.mfapi.in/mf/${selectedFund.schemeCode}`)
    .then(r=>r.json())
    .then(data=>{
      let nav=parseFloat(data.data[0].nav);
      funds.push({name:selectedFund.schemeName, code:selectedFund.schemeCode, nav:nav, buyAvg:0, invest:0});
      save(); render();
    });
}

function refreshNAVs(){
  funds.forEach((f,i)=>{
    fetch(`https://api.mfapi.in/mf/${f.code}`)
      .then(r=>r.json())
      .then(data=>{
        f.nav=parseFloat(data.data[0].nav);
        save(); render();
      });
  });
}

function clearAllFunds(){
  if(confirm("Are you sure you want to clear all funds?")){
    funds=[]; save(); render();
  }
}

function removeFund(index){
  if(confirm(`Remove fund "${funds[index].name}"?`)){
    funds.splice(index,1); save(); render();
  }
}

// Autocomplete
const fundInput=document.getElementById("fundInput");
const fundDropdown=document.getElementById("fundDropdown");

fundInput.addEventListener("input",()=>{
  const q=fundInput.value.trim().toLowerCase();
  fundDropdown.innerHTML="";
  if(!q){ fundDropdown.style.display="none"; return; }
  const matches=mfList.filter(f=>f.schemeName.toLowerCase().includes(q)).slice(0,10);
  matches.forEach(f=>{
    const div=document.createElement("div");
    div.textContent=f.schemeName;
    div.onclick=()=>{ addFund(f); fundInput.value=""; fundDropdown.style.display="none"; };
    fundDropdown.appendChild(div);
  });
  fundDropdown.style.display=matches.length?"block":"none";
});

document.addEventListener("click",e=>{
  if(!e.target.closest(".container")) fundDropdown.style.display="none";
});

render();
</script>

</body>
</html>
