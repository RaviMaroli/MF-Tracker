<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mutual Fund Tracker</title>
<style>
body { font-family: Arial, sans-serif; padding: 10px; }
input, select, button { padding: 6px; margin: 3px 0; font-size: 16px; }
button { margin-right: 5px; margin-top: 5px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
input[type="number"] { width: 90px; }
.profit { color: green; font-weight: bold; }
.loss { color: red; font-weight: bold; }
#fundInput { width: 50%; }
#fundDropdown { width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid #ccc; display: none; position: absolute; background: #fff; z-index: 1000; }
#fundDropdown div { padding: 5px; cursor: pointer; }
#fundDropdown div:hover { background: #eee; }
.container { position: relative; }
.total-row { font-weight: bold; background: #f0f0f0; }
.fund-name { cursor: pointer; text-decoration: underline; color: #007bff; }
</style>
</head>
<body>

<h2>Mutual Fund Tracker</h2>

<div class="container">
  <input type="text" id="fundInput" placeholder="Type fund name (partial)">
  <div id="fundDropdown"></div>
</div>

<!-- Buttons below input -->
<div>
  <button onclick="refreshNAVs()">ðŸ”„ Refresh NAVs</button>
  <button onclick="clearAllFunds()">ðŸ—‘ Clear All</button>
</div>

<table>
  <thead>
    <tr>
      <th>Fund</th>
      <th>Current NAV (â‚¹)</th>
      <th>Buy Avg (â‚¹)</th>
      <th>Investment (â‚¹)</th>
      <th>P / L (â‚¹)</th>
    </tr>
  </thead>
  <tbody id="fundTable"></tbody>
</table>

<script>
// State
let funds = JSON.parse(localStorage.getItem("funds") || "[]");
let mfList = [];

// Fetch all funds from mfapi
fetch("https://api.mfapi.in/mf")
  .then(r => r.json())
  .then(data => mfList = data);

// Save funds to localStorage
function save() {
  localStorage.setItem("funds", JSON.stringify(funds));
}

// Render table with clickable fund names
function render() {
  const tbody = document.getElementById("fundTable");
  tbody.innerHTML = "";

  let totalInvestment = 0;
  let totalPL = 0;

  funds.forEach((f,i) => {
    let pl = 0;
    let units = 0;

    if(f.buyAvg > 0 && f.invest > 0 && f.nav > 0) {
      units = f.invest / f.buyAvg;
      let currentValue = units * f.nav;
      pl = currentValue - f.invest;
      totalPL += pl;
      totalInvestment += parseFloat(f.invest) || 0;
    }

    tbody.innerHTML += `
      <tr>
        <td class="fund-name" onclick="removeFund(${i})">${f.name}</td>
        <td>${f.nav || "-"}</td>
        <td><input type="number" step="0.01" value="${f.buyAvg}" onchange="funds[${i}].buyAvg=this.value; save(); render();"></td>
        <td><input type="number" value="${f.invest}" onchange="funds[${i}].invest=this.value; save(); render();"></td>
        <td class="${pl >=0 ? 'profit' : 'loss'}">${pl.toFixed(2)}</td>
      </tr>
    `;
  });

  // Total row
  if(funds.length > 0) {
    tbody.innerHTML += `
      <tr class="total-row">
        <td>Total</td>
        <td>-</td>
        <td>-</td>
        <td>${totalInvestment.toFixed(2)}</td>
        <td class="${totalPL >=0 ? 'profit' : 'loss'}">${totalPL.toFixed(2)}</td>
      </tr>
    `;
  }
}

// Add fund from selection
function addFund(selectedFund) {
  if(funds.length >= 20) { alert("Max 20 funds allowed"); return; }

  fetch(`https://api.mfapi.in/mf/${selectedFund.schemeCode}`)
    .then(r => r.json())
    .then(data => {
      let nav = parseFloat(data.data[0].nav);
      funds.push({
        name: selectedFund.schemeName,
        code: selectedFund.schemeCode,
        nav: nav,
        buyAvg: 0,
        invest: 0
      });
      save();
      render();
    });
}

// Refresh NAVs
function refreshNAVs() {
  funds.forEach((f,i) => {
    fetch(`https://api.mfapi.in/mf/${f.code}`)
      .then(r => r.json())
      .then(data => {
        f.nav = parseFloat(data.data[0].nav);
        save();
        render();
      });
  });
}

// Clear all funds
function clearAllFunds() {
  if(confirm("Are you sure you want to clear all funds?")) {
    funds = [];
    save();
    render();
  }
}

// Remove single fund
function removeFund(index) {
  if(confirm(`Remove fund "${funds[index].name}"?`)) {
    funds.splice(index,1);
    save();
    render();
  }
}

// Autocomplete dropdown
const fundInput = document.getElementById("fundInput");
const fundDropdown = document.getElementById("fundDropdown");

fundInput.addEventListener("input", () => {
  const q = fundInput.value.trim().toLowerCase();
  fundDropdown.innerHTML = "";
  if(!q) { fundDropdown.style.display = "none"; return; }

  const matches = mfList.filter(f => f.schemeName.toLowerCase().includes(q)).slice(0, 10);
  matches.forEach(f => {
    const div = document.createElement("div");
    div.textContent = f.schemeName;
    div.onclick = () => {
      addFund(f);
      fundInput.value = "";
      fundDropdown.style.display = "none";
    };
    fundDropdown.appendChild(div);
  });

  fundDropdown.style.display = matches.length ? "block" : "none";
});

document.addEventListener("click", e => {
  if(!e.target.closest(".container")) fundDropdown.style.display = "none";
});

render();
</script>

</body>
</html>
